name: "Unit Tests"

on:
  workflow_dispatch:
  push:
    branches: [ "senpai", "kouhai" ]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ "senpai", "kouhai" ]

jobs:
  testing:
    name: Testing
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.1

      - name: Cache Qt dependencies
        uses: actions/cache@v2
        with:
          path: ${{ github.workspace }}/qt
          key: qt-${{ runner.os }}-${{ hashFiles('**/qt/**') }}

      - name: Install Qt
        if: steps.cache.outputs.cache-hit != 'true'
        uses: jurplel/install-qt-action@v3.3.0
        with:
          version: '6.6.2'
          modules: 'qtwebsockets'
          dir: ${{ github.workspace }}/qt

      - name: Build
        run: cd tests && mkdir build && cd build && cmake .. && make

      - name: Run tests
        run: cd tests/build && ctest --output-junit testResults.xml

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: success() || failure() # always run even if the previous step fails
        with:
          report_paths: '**/tests/build/testResults.xml'
